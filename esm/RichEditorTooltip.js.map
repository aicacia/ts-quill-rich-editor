{"version":3,"file":"RichEditorTooltip.js","sources":["../src/RichEditorTooltip.ts"],"sourcesContent":["import Quill from \"quill\";\nimport \"long-press-event\";\nimport type * as RegistryModule from \"parchment/src/registry\";\nimport type { BoundsStatic, Sources } from \"quill\";\nimport type { RangeStatic } from \"quill\";\nimport type TooltipClass from \"quill/ui/tooltip\";\n\nconst Parchment = Quill.import(\"parchment\");\nconst Registry: typeof RegistryModule = Parchment.Registry;\nconst LinkBlot = Quill.import(\"formats/link\");\nconst FormulaBlot = Quill.import(\"formats/formula\");\nconst Tooltip: typeof TooltipClass = Quill.import(\"ui/tooltip\");\n\nexport class RichEditorTooltip extends Tooltip {\n  static TEMPLATE = [\n    '<span class=\"ql-tooltip-arrow\"></span>',\n    '<div class=\"ql-tooltip-editor\">',\n    '<input type=\"text\" data-link=\"https://quilljs.com\" data-video=\"Embed URL\"/>',\n    '<textarea placeholder=\"e=mc^2\"></textarea>',\n    '<div class=\"ql-katex\"></div>',\n    '<a class=\"ql-close\"></a>',\n    '<a class=\"ql-save\"></a>',\n    \"</div>\",\n  ].join(\"\");\n\n  protected textbox: HTMLInputElement;\n  protected textarea: HTMLTextAreaElement;\n  protected katex: HTMLDivElement;\n  protected range: RangeStatic | undefined;\n\n  constructor(quill: Quill, bounds?: HTMLElement) {\n    super(quill, bounds);\n    this.textbox = this.root.querySelector(\n      'input[type=\"text\"]'\n    ) as HTMLInputElement;\n    this.textarea = this.root.querySelector(\"textarea\") as HTMLTextAreaElement;\n    this.katex = this.root.querySelector(\"div.ql-katex\") as HTMLDivElement;\n    this.listen();\n  }\n\n  listen() {\n    const container = (this.quill as any).container as HTMLElement;\n    container.setAttribute(\"data-long-press-delay\", \"500\");\n    container.addEventListener(\"long-press\", () => {\n      if (this.root.classList.contains(\"ql-editing\")) return;\n      const range = this.quill.getSelection(true);\n      if (range) {\n        this.openAt(range);\n      }\n    });\n    container.addEventListener(\"keydown\", (event) => {\n      if (event.key === \"Escape\") {\n        this.hide();\n        event.preventDefault();\n      }\n    });\n    container.addEventListener(\n      \"click\",\n      (event) => {\n        const blot = Registry.find(event.target as HTMLElement, true);\n\n        if (blot) {\n          if (blot instanceof FormulaBlot) {\n            this.range = {\n              index: blot.offset(this.quill.scroll),\n              length: blot.length(),\n            };\n            this.edit(\"formula\", FormulaBlot.value(blot.domNode));\n            event.preventDefault();\n            event.stopPropagation();\n          }\n        }\n      },\n      { capture: true }\n    );\n    this.textarea.addEventListener(\"input\", () => {\n      (window as any).katex.render(this.textarea.value, this.katex, {\n        throwOnError: false,\n        errorColor: \"#f00\",\n      });\n    });\n    this.textbox.addEventListener(\"keydown\", (event) => {\n      if (event.key === \"Enter\") {\n        this.save();\n        event.preventDefault();\n      } else if (event.key === \"Escape\") {\n        this.cancel();\n        event.preventDefault();\n      }\n    });\n    this.quill.on(\n      \"selection-change\",\n      (range: RangeStatic, _oldRange: RangeStatic, source: Sources) => {\n        if (range != null && source === \"user\") {\n          if (range.length > 0) {\n            this.openAt(range);\n          } else {\n            const [link, linkOffset] = (this.quill.scroll as any).descendant(\n              LinkBlot,\n              range.index\n            );\n            if (link != null) {\n              this.range = {\n                index: range.index - linkOffset,\n                length: link.length(),\n              };\n              this.edit(\"link\", LinkBlot.formats(link.domNode));\n            }\n          }\n        } else if (\n          document.activeElement !== this.textbox &&\n          this.quill.hasFocus()\n        ) {\n          this.hide();\n        }\n      }\n    );\n    this.root.querySelector(\".ql-save\")?.addEventListener(\"click\", () => {\n      this.save();\n    });\n    this.root.querySelector(\".ql-close\")?.addEventListener(\"click\", () => {\n      this.cancel();\n    });\n    this.quill.on(\"scroll-optimize\" as any, () => {\n      setTimeout(() => {\n        if (this.root.classList.contains(\"ql-hidden\")) return;\n        const range = this.quill.getSelection();\n        if (range != null) {\n          this.position(this.quill.getBounds(range.index, range.length));\n        }\n      }, 1);\n    });\n  }\n\n  openAt(range: RangeStatic) {\n    this.show();\n    this.root.style.left = \"0px\";\n    this.root.style.width = \"\";\n    this.root.style.width = `${this.root.offsetWidth}px`;\n    const lines = this.quill.getLines(range.index, range.length);\n    if (lines.length <= 1) {\n      this.position(this.quill.getBounds(range.index, range.length));\n    } else {\n      const lastLine = lines[lines.length - 1];\n      const index = this.quill.getIndex(lastLine);\n      const length = Math.min(\n        lastLine.length() - 1,\n        range.index + range.length - index\n      );\n      const indexBounds = this.quill.getBounds(index, length);\n      this.position(indexBounds);\n    }\n  }\n\n  position(reference: BoundsStatic) {\n    const left =\n      reference.left + reference.width / 2 - this.root.offsetWidth / 2;\n    const top = reference.bottom + this.quill.root.scrollTop;\n    this.root.style.left = `${left}px`;\n    this.root.style.top = `${top}px`;\n    const containerBounds = this.boundsContainer.getBoundingClientRect();\n    const rootBounds = this.root.getBoundingClientRect();\n    let shift = 0;\n    if (rootBounds.right > containerBounds.right) {\n      shift = containerBounds.right - rootBounds.right;\n      this.root.style.left = `${left + shift}px`;\n    }\n    if (rootBounds.left < containerBounds.left) {\n      shift = containerBounds.left - rootBounds.left;\n      this.root.style.left = `${left + shift}px`;\n    }\n    const arrow = this.root.querySelector(\".ql-tooltip-arrow\") as HTMLElement;\n    arrow.style.marginLeft = \"\";\n    if (shift !== 0) {\n      arrow.style.marginLeft = `${-1 * shift - arrow.offsetWidth / 2}px`;\n    }\n    return shift;\n  }\n\n  show() {\n    this.root.classList.remove(\"ql-editing\");\n    this.root.classList.remove(\"ql-hidden\");\n    if (this.textbox) this.textbox.value = \"\";\n    if (this.textarea) this.textarea.value = \"\";\n    if (this.katex) this.katex.innerHTML = \"\";\n    this.root.removeAttribute(\"data-mode\");\n  }\n\n  hide() {\n    this.root.classList.remove(\"ql-editing\");\n    this.root.classList.add(\"ql-hidden\");\n    this.root.removeAttribute(\"data-mode\");\n  }\n\n  cancel() {\n    this.show();\n  }\n\n  edit(mode: string, preview?: string) {\n    this.root.classList.remove(\"ql-hidden\");\n    this.root.classList.add(\"ql-editing\");\n    if (preview != null) {\n      if (mode === \"formula\") {\n        this.textarea.value = preview;\n        this.textbox.value = \"\";\n      } else {\n        this.textbox.value = preview;\n        this.textarea.value = \"\";\n      }\n    }\n    this.position(\n      this.quill.getBounds((this.quill as any).selection.savedRange)\n    );\n    if (mode === \"formula\") {\n      this.textarea.select();\n    } else {\n      this.textbox.select();\n      this.textbox.setAttribute(\n        \"placeholder\",\n        this.textbox.getAttribute(`data-${mode}`) || \"\"\n      );\n    }\n    this.root.setAttribute(\"data-mode\", mode);\n  }\n\n  restoreFocus() {\n    const scrollingContainer: HTMLElement = (this.quill as any)\n        .scrollingContainer,\n      scrollTop = scrollingContainer.scrollTop;\n    this.quill.focus();\n    scrollingContainer.scrollTop = scrollTop;\n  }\n\n  save() {\n    const mode = this.root.getAttribute(\"data-mode\");\n    let value = mode === \"formula\" ? this.textarea.value : this.textbox.value;\n    switch (mode) {\n      case \"link\": {\n        const scrollTop = this.quill.root.scrollTop;\n        if (this.range) {\n          this.quill.formatText(this.range, \"link\", value, \"user\");\n          this.range = undefined;\n        } else {\n          this.restoreFocus();\n          this.quill.format(\"link\", value, \"user\");\n        }\n        this.quill.root.scrollTop = scrollTop;\n        break;\n      }\n      case \"video\": {\n        value = extractVideoUrl(value);\n      }\n      case \"formula\": {\n        if (!value) break;\n        if (this.range) {\n          this.quill.deleteText(this.range.index, this.range.length, \"user\");\n          this.range = undefined;\n        }\n        const range = this.quill.getSelection(true);\n        if (range != null) {\n          const index = range.index + range.length;\n          this.quill.insertEmbed(index, mode, value, \"user\");\n          if (mode === \"formula\") {\n            this.quill.insertText(index + 1, \" \", \"user\");\n          }\n          this.quill.setSelection(index + 2, 0, \"user\");\n        }\n        break;\n      }\n      default:\n    }\n    this.hide();\n  }\n}\n\nfunction extractVideoUrl(url: string): string {\n  let match =\n    url.match(\n      /^(?:(https?):\\/\\/)?(?:(?:www|m)\\.)?youtube\\.com\\/watch.*v=([a-zA-Z0-9_-]+)/\n    ) ||\n    url.match(/^(?:(https?):\\/\\/)?(?:(?:www|m)\\.)?youtu\\.be\\/([a-zA-Z0-9_-]+)/);\n\n  if (match) {\n    return `${match[1] || \"https\"}://www.youtube.com/embed/${\n      match[2]\n    }?showinfo=0`;\n  } else if (\n    (match = url.match(/^(?:(https?):\\/\\/)?(?:www\\.)?vimeo\\.com\\/(\\d+)/))\n  ) {\n    return `${match[1] || \"https\"}://player.vimeo.com/video/${match[2]}/`;\n  } else {\n    return url;\n  }\n}\n"],"names":["Registry","Quill","import","LinkBlot","FormulaBlot","Tooltip","RichEditorTooltip","constructor","quill","bounds","super","this","textbox","root","querySelector","textarea","katex","listen","container","setAttribute","addEventListener","classList","contains","range","getSelection","openAt","event","key","hide","preventDefault","blot","find","target","index","offset","scroll","length","edit","value","domNode","stopPropagation","capture","window","render","throwOnError","errorColor","save","cancel","on","_oldRange","source","link","linkOffset","descendant","formats","document","activeElement","hasFocus","setTimeout","position","getBounds","show","style","left","width","offsetWidth","lines","getLines","lastLine","getIndex","Math","min","indexBounds","reference","top","bottom","scrollTop","containerBounds","boundsContainer","getBoundingClientRect","rootBounds","shift","right","arrow","marginLeft","remove","innerHTML","removeAttribute","add","mode","preview","selection","savedRange","select","getAttribute","restoreFocus","scrollingContainer","focus","formatText","undefined","format","url","match","extractVideoUrl","deleteText","insertEmbed","insertText","setSelection","join"],"mappings":"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"}