import t from"https://unpkg.com/quill@2.0.0-dev.4/dist/quill.js";import"https://unpkg.com/long-press-event@2/dist/long-press-event.min.js";const e=t.import("parchment").Registry,i=t.import("formats/link"),s=t.import("formats/formula"),o=t.import("ui/tooltip");class l extends o{constructor(t,e){super(t,e),this.textbox=this.root.querySelector('input[type="text"]'),this.textarea=this.root.querySelector("textarea"),this.katex=this.root.querySelector("div.ql-katex"),this.listen()}listen(){var t,o;const l=this.quill.container;l.setAttribute("data-long-press-delay","500"),l.addEventListener("long-press",(()=>{if(this.root.classList.contains("ql-editing"))return;const t=this.quill.getSelection(!0);t&&this.openAt(t)})),l.addEventListener("keydown",(t=>{"Escape"===t.key&&(this.hide(),t.preventDefault())})),l.addEventListener("click",(t=>{const i=e.find(t.target,!0);i&&i instanceof s&&(this.range={index:i.offset(this.quill.scroll),length:i.length()},this.edit("formula",s.value(i.domNode)),t.preventDefault(),t.stopPropagation())}),{capture:!0}),this.textarea.addEventListener("input",(()=>{window.katex.render(this.textarea.value,this.katex,{throwOnError:!1,errorColor:"#f00"})})),this.textbox.addEventListener("keydown",(t=>{"Enter"===t.key?(this.save(),t.preventDefault()):"Escape"===t.key&&(this.cancel(),t.preventDefault())})),this.quill.on("selection-change",((t,e,s)=>{if(null!=t&&"user"===s)if(t.length>0)this.openAt(t);else{const[e,s]=this.quill.scroll.descendant(i,t.index);null!=e&&(this.range={index:t.index-s,length:e.length()},this.edit("link",i.formats(e.domNode)))}else document.activeElement!==this.textbox&&this.quill.hasFocus()&&this.hide()})),null===(t=this.root.querySelector(".ql-save"))||void 0===t||t.addEventListener("click",(()=>{this.save()})),null===(o=this.root.querySelector(".ql-close"))||void 0===o||o.addEventListener("click",(()=>{this.cancel()})),this.quill.on("scroll-optimize",(()=>{setTimeout((()=>{if(this.root.classList.contains("ql-hidden"))return;const t=this.quill.getSelection();null!=t&&this.position(this.quill.getBounds(t.index,t.length))}),1)}))}openAt(t){this.show(),this.root.style.left="0px",this.root.style.width="",this.root.style.width=`${this.root.offsetWidth}px`;const e=this.quill.getLines(t.index,t.length);if(e.length<=1)this.position(this.quill.getBounds(t.index,t.length));else{const i=e[e.length-1],s=this.quill.getIndex(i),o=Math.min(i.length()-1,t.index+t.length-s),l=this.quill.getBounds(s,o);this.position(l)}}position(t){const e=t.left+t.width/2-this.root.offsetWidth/2,i=t.bottom+this.quill.root.scrollTop;this.root.style.left=`${e}px`,this.root.style.top=`${i}px`;const s=this.boundsContainer.getBoundingClientRect(),o=this.root.getBoundingClientRect();let l=0;o.right>s.right&&(l=s.right-o.right,this.root.style.left=`${e+l}px`),o.left<s.left&&(l=s.left-o.left,this.root.style.left=`${e+l}px`);const r=this.root.querySelector(".ql-tooltip-arrow");return r.style.marginLeft="",0!==l&&(r.style.marginLeft=-1*l-r.offsetWidth/2+"px"),l}show(){this.root.classList.remove("ql-editing"),this.root.classList.remove("ql-hidden"),this.textbox&&(this.textbox.value=""),this.textarea&&(this.textarea.value=""),this.katex&&(this.katex.innerHTML=""),this.root.removeAttribute("data-mode")}hide(){this.root.classList.remove("ql-editing"),this.root.classList.add("ql-hidden"),this.root.removeAttribute("data-mode")}cancel(){this.show()}edit(t,e){this.root.classList.remove("ql-hidden"),this.root.classList.add("ql-editing"),null!=e&&("formula"===t?(this.textarea.value=e,this.textbox.value=""):(this.textbox.value=e,this.textarea.value="")),this.position(this.quill.getBounds(this.quill.selection.savedRange)),"formula"===t?this.textarea.select():(this.textbox.select(),this.textbox.setAttribute("placeholder",this.textbox.getAttribute(`data-${t}`)||"")),this.root.setAttribute("data-mode",t)}restoreFocus(){const t=this.quill.scrollingContainer,e=t.scrollTop;this.quill.focus(),t.scrollTop=e}save(){const t=this.root.getAttribute("data-mode");let e="formula"===t?this.textarea.value:this.textbox.value;switch(t){case"link":{const t=this.quill.root.scrollTop;this.range?(this.quill.formatText(this.range,"link",e,"user"),this.range=void 0):(this.restoreFocus(),this.quill.format("link",e,"user")),this.quill.root.scrollTop=t;break}case"video":e=function(t){let e=t.match(/^(?:(https?):\/\/)?(?:(?:www|m)\.)?youtube\.com\/watch.*v=([a-zA-Z0-9_-]+)/)||t.match(/^(?:(https?):\/\/)?(?:(?:www|m)\.)?youtu\.be\/([a-zA-Z0-9_-]+)/);return e?`${e[1]||"https"}://www.youtube.com/embed/${e[2]}?showinfo=0`:(e=t.match(/^(?:(https?):\/\/)?(?:www\.)?vimeo\.com\/(\d+)/))?`${e[1]||"https"}://player.vimeo.com/video/${e[2]}/`:t}(e);case"formula":{if(!e)break;this.range&&(this.quill.deleteText(this.range.index,this.range.length,"user"),this.range=void 0);const i=this.quill.getSelection(!0);if(null!=i){const s=i.index+i.length;this.quill.insertEmbed(s,t,e,"user"),"formula"===t&&this.quill.insertText(s+1," ","user"),this.quill.setSelection(s+2,0,"user")}break}}this.hide()}}l.TEMPLATE=['<span class="ql-tooltip-arrow"></span>','<div class="ql-tooltip-editor">','<input type="text" data-link="https://quilljs.com" data-video="Embed URL"/>','<textarea placeholder="e=mc^2"></textarea>','<div class="ql-katex"></div>','<a class="ql-close"></a>','<a class="ql-save"></a>',"</div>"].join("");export{l as RichEditorTooltip};
//# sourceMappingURL=RichEditorTooltip.js.map
